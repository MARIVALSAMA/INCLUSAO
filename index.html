<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Gerências</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-open {
            transform: translateX(0);
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
        }
        .modal {
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Diretoria de Inclusão
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Acesse sua conta para continuar
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Endereço de e-mail">
                    </div>
                    <div>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Senha">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
                 <p id="login-error" class="text-sm text-red-500 text-center"></p>
            </form>
            <div class="text-sm text-center">
                <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Não tem uma conta? Cadastre-se
                </a>
            </div>
        </div>
    </div>
    
     <!-- Register Container -->
    <div id="register-container" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Criar Nova Conta
                </h2>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm">
                    <div>
                        <input id="register-email" name="email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Endereço de e-mail">
                    </div>
                    <div class="mt-4">
                        <input id="register-password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Senha (mínimo 6 caracteres)">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cadastrar
                    </button>
                </div>
                <p id="register-error" class="text-sm text-red-500 text-center"></p>
            </form>
            <div class="text-sm text-center">
                <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Já tem uma conta? Entre
                </a>
            </div>
        </div>
    </div>


    <!-- App Container -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 transition duration-200 ease-in-out sidebar-closed md:sidebar-open">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="fas fa-universal-access text-2xl"></i>
                <span class="text-xl font-extrabold">Diretoria de Inclusão</span>
            </a>
            <nav id="nav-gerencias">
                <!-- As gerências serão carregadas aqui pelo JS -->
            </nav>
            <div class="px-4 mt-6">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Recursos</h3>
                <a href="#" data-gerencia="documentos" class="gerencia-link flex items-center space-x-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 transition-colors duration-200 mt-2">
                    <i class="fas fa-file-alt w-6 text-center"></i>
                    <span>Documentos</span>
                </a>
                 <a href="#" data-gerencia="multimidia" class="gerencia-link flex items-center space-x-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 transition-colors duration-200 mt-2">
                    <i class="fas fa-photo-video w-6 text-center"></i>
                    <span>Multimídia</span>
                </a>
            </div>
        </aside>

        <!-- Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                    <h1 id="header-title" class="text-2xl font-bold text-gray-800 ml-4">Bem-vindo!</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-right">
                        <p id="user-email" class="font-medium text-gray-700"></p>
                        <p id="user-role" class="text-xs text-gray-500 capitalize"></p>
                    </div>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div id="content-area" class="container mx-auto">
                    <!-- Conteúdo dinâmico será carregado aqui -->
                </div>
            </main>
        </div>
    </div>


    <!-- Modal Genérico -->
    <div id="modal" class="hidden fixed inset-0 w-full h-full modal-backdrop flex items-center justify-center">
        <div class="modal bg-white rounded-lg shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-6 transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="modal-close" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="mt-4">
                <!-- Formulário do modal será injetado aqui -->
            </div>
        </div>
    </div>
    
    <!-- Bibliotecas de exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Módulo Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        const firebaseConfig = {
          apiKey: "AIzaSyBh866AyAWcFBxQ5Lxij8pBz43KrQoydEA",
          authDomain: "inclusao-4d763.firebaseapp.com",
          projectId: "inclusao-4d763",
          storageBucket: "inclusao-4d763.appspot.com",
          messagingSenderId: "659733821935",
          appId: "1:659733821935:web:20029eca7032d841b95e1a",
          measurementId: "G-RW483FFWF1"
        };
        const appId = "diretoria-inclusao-app";
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        const GERENCIAS_INFO = {
            'inclusao': { nome: 'Diretoria de Inclusão', icon: 'fa-universal-access' },
            'povos_tradicionais': { nome: 'Comunidade e Povos Tradicionais', icon: 'fa-users' },
            'ameei': { nome: 'AMEEI', icon: 'fa-hands-helping' },
            'socioeducacional': { nome: 'Socioeducacional', icon: 'fa-graduation-cap' },
            // Mantidos para referência, mas não no menu principal
            'multimidia': { nome: 'Multimídia', icon: 'fa-photo-video' },
            'documentos': { nome: 'Documentos', icon: 'fa-file-alt' }
        };

        // IDs das diretorias principais a serem exibidas no menu
        const gerenciaIds = ['inclusao', 'povos_tradicionais', 'ameei', 'socioeducacional'];

        let state = {
            selectedGerencia: null,
            selectedAba: null,
            data: {},
            currentUser: null
        };

        // Dados iniciais
        const initialLibrasProfessionals = [
            { id: "libra-01", nome: "DAVI SANTOS LIRO", cargo: "LIBRAS – NÍVEL II", unidadeEscolar: "IRENE ANDRADE", alunosAtendidos: "PÂMELA E WILLIAN" },
            { id: "libra-02", nome: "LIDIANE SACRAMENTO", cargo: "LIBRAS – NÍVEL II", unidadeEscolar: "CMA, IRENE ANDRADE, CRECHE BAIXA DA CANDEIA", alunosAtendidos: "RAÍSSA PEREIRA, WILLIAN, ERICK DA PAIXÃO" },
            { id: "libra-03", nome: "GABRIEL MACEDO DE CARVALHO", cargo: "LIBRAS – NÍVEL I", unidadeEscolar: "JAIRO AZI ( RIACHO DA GUIA )", alunosAtendidos: "BRUNO DOS SANTOS BISPO" },
            { id: "libra-04", nome: "INALDICE DOS SANTOS REIS", cargo: "LIBRAS – NÍVEL II", unidadeEscolar: "CMA", alunosAtendidos: "RUAN E LUDIMILA" },
            { id: "libra-05", nome: "NAOMY RAISSA DE OLIVEIRA SILVA RABELO DE BRITO", cargo: "LIBRAS – NÍVEL I", unidadeEscolar: "PEDRO FURTADO", alunosAtendidos: "" },
            { id: "libra-06", nome: "ERNANES CASTRO DOS SANTOS JUNIOR", cargo: "LIBRAS – NÍVEL I", unidadeEscolar: "RIO BRANCO", alunosAtendidos: "" }
        ];

        const escolasIniciais = [
             { id: "c29e6129-923f-4e4b-87d3-356a31c5b882", nome: 'AMEEI - Núcleo de Atendimento Multidisciplinar Educacional Especializado em Inclusão', detalhes: '0 alunos matriculados' },
             { id: "5a1a1a7a-9b1e-4f7f-8d4e-3f1d3c1a3b1a", nome: 'Centro Educacional Murilo Coelho Cavalcanti', detalhes: '76 alunos matriculados' },
             { id: "a3b2b1a0-3c1d-4e2f-8a4b-1a2b3c4d5e6f", nome: 'Colégio Municipal de Alagoinhas', detalhes: '779 alunos matriculados' },
             { id: "f4e5d6c7-9b8a-4d3c-8b2a-1a2b3c4d5e6f", nome: 'Colégio Municipal Doutor Jairo Azi', detalhes: '468 alunos matriculados' },
             { id: "b1a2c3d4-e5f6-4a7b-8c9d-1a2b3c4d5e6f", nome: 'Colégio Municipal Miguel Santos Fontes', detalhes: '156 alunos matriculados' },
             { id: "e1f2a3b4-c5d6-4e7f-8a9b-1a2b3c4d5e6f", nome: 'Creche Escola Municipal Rosário da Caridade', detalhes: '100 alunos matriculados' },
             { id: "f1a2b3c4-d5e6-4f7a-8b9c-1a2b3c4d5e6f", nome: 'Creche Escola Municipal São José Operário', detalhes: '103 alunos matriculados' },
             { id: "a1b2c3d4-e5f6-4a7b-8c9d-1a2b3c4d5e6f", nome: 'Creche Municipal Alagoinhas IV', detalhes: '108 alunos matriculados' },
             { id: "b2c3d4e5-f6a7-4b8c-9d1a-1a2b3c4d5e6f", nome: 'Creche Municipal Alegria da Mamãe', detalhes: '78 alunos matriculados' },
             { id: "c3d4e5f6-a7b8-4c9d-1a2b-1a2b3c4d5e6f", nome: 'Creche Municipal Ana Oliveira Campos', detalhes: '100 alunos matriculados' },
             { id: "d4e5f6a7-b8c9-4d1a-2b3c-1a2b3c4d5e6f", nome: 'Creche Municipal Baixa da Candeia', detalhes: '79 alunos matriculados' },
             { id: "e5f6a7b8-c9d1-4e2b-3c4d-1a2b3c4d5e6f", nome: 'Creche Municipal Girassol', detalhes: '80 alunos matriculados' },
             { id: "f6a7b8c9-d1e2-4f3c-4d5e-1a2b3c4d5e6f", nome: 'Creche Municipal Imaculada Conceição', detalhes: '101 alunos matriculados' },
             { id: "a7b8c9d1-e2f3-4a4d-5e6f-1a2b3c4d5e6f", nome: 'Creche Municipal Parque São Bernardo', detalhes: '49 alunos matriculados' },
             { id: "b8c9d1e2-f3a4-4b5e-6f7a-1a2b3c4d5e6f", nome: 'Creche Municipal Santo Antônio', detalhes: '108 alunos matriculados' },
             { id: "c9d1e2f3-a4b5-4c6f-7a8b-1a2b3c4d5e6f", nome: 'Creche Municipal São Benedito', detalhes: '55 alunos matriculados' },
             { id: "d1e2f3a4-b5c6-4d7a-8b9c-1a2b3c4d5e6f", nome: 'Creche Municipal São José', detalhes: '71 alunos matriculados' },
             { id: "e2f3a4b5-c6d7-4e8b-9c1d-1a2b3c4d5e6f", nome: 'Escola Municipal Alagoinhas IV', detalhes: '304 alunos matriculados' },
             { id: "f3a4b5c6-d7e8-4f9c-1d2e-1a2b3c4d5e6f", nome: 'Escola Municipal Alaíde Santana Santos', detalhes: '135 alunos matriculados' },
             { id: "a4b5c6d7-e8f9-4a1d-2e3f-1a2b3c4d5e6f", nome: 'Escola Municipal Álvaro Müller', detalhes: '351 alunos matriculados' },
             { id: "b5c6d7e8-f9a1-4b2e-3f4a-1a2b3c4d5e6f", nome: 'Escola Municipal Amando Alves de Azevedo', detalhes: '124 alunos matriculados' },
             { id: "c6d7e8f9-a1b2-4c3f-4a5b-1a2b3c4d5e6f", nome: 'Escola Municipal Comunitária Nova Esperança', detalhes: '186 alunos matriculados' },
             { id: "d7e8f9a1-b2c3-4d4a-5b6c-1a2b3c4d5e6f", nome: 'Escola Municipal Dom Avelar Brandão Vilela', detalhes: '233 alunos matriculados' },
             { id: "e8f9a1b2-c3d4-4e5b-6c7d-1a2b3c4d5e6f", nome: 'Escola Municipal Doutor Carlos Santana', detalhes: '109 alunos matriculados' },
             { id: "f9a1b2c3-d4e5-4f6c-7d8e-1a2b3c4d5e6f", nome: 'Escola Municipal Eraldo Tinoco de Melo', detalhes: '161 alunos matriculados' },
             { id: "a1b2c3d4-e5f6-4a7b-8c9d-f9a1b2c3d4e5", nome: 'Escola Municipal Érico Veríssimo', detalhes: '74 alunos matriculados' },
             { id: "b2c3d4e5-f6a7-4b8c-9d1a-a1b2c3d4e5f6", nome: 'Escola Municipal General Osório', detalhes: '91 alunos matriculados' },
             { id: "c3d4e5f6-a7b8-4c9d-1a2b-b2c3d4e5f6a7", nome: 'Escola Municipal Gonçalo Muniz', detalhes: '99 alunos matriculados' },
             { id: "d4e5f6a7-b8c9-4d1a-2b3c-c3d4e5f6a7b8", nome: 'Escola Municipal Hermes de Carvalho', detalhes: '215 alunos matriculados' },
             { id: "e5f6a7b8-c9d1-4e2b-3c4d-d4e5f6a7b8c9", nome: 'Escola Municipal Irene Andrade de Assis', detalhes: '417 alunos matriculados' },
             { id: "f6a7b8c9-d1e2-4f3c-4d5e-e5f6a7b8c9d1", nome: 'Escola Municipal Isaías Figueiredo', detalhes: '227 alunos matriculados' },
             { id: "a7b8c9d1-e2f3-4a4d-5e6f-f6a7b8c9d1e2", nome: 'Escola Municipal Jardim Petrolar', detalhes: '450 alunos matriculados' },
             { id: "b8c9d1e2-f3a4-4b5e-6f7a-a7b8c9d1e2f3", nome: 'Escola Municipal Joana D’Arc', detalhes: '127 alunos matriculados' },
             { id: "c9d1e2f3-a4b5-4c6f-7a8b-b8c9d1e2f3a4", nome: 'Escola Municipal José Abelha Flores', detalhes: '135 alunos matriculados' },
             { id: "d1e2f3a4-b5c6-4d7a-8b9c-c9d1e2f3a4b5", nome: 'Escola Municipal José Antônio da Silva Lima', detalhes: '202 alunos matriculados' },
             { id: "e2f3a4b5-c6d7-4e8b-9c1d-d1e2f3a4b5c6", nome: 'Escola Municipal José de Anchieta', detalhes: '215 alunos matriculados' },
             { id: "f3a4b5c6-d7e8-4f9c-1d2e-e2f3a4b5c6d7", nome: 'Escola Municipal José Honorato', detalhes: '272 alunos matriculados' },
             { id: "a4b5c6d7-e8f9-4a1d-2e3f-f3a4b5c6d7e8", nome: 'Escola Municipal José Nicolau da Silva', detalhes: '120 alunos matriculados' },
             { id: "b5c6d7e8-f9a1-4b2e-3f4a-a4b5c6d7e8f9", nome: 'Escola Municipal Liodório Borges dos Santos', detalhes: '166 alunos matriculados' },
             { id: "c6d7e8f9-a1b2-4c3f-4a5b-b5c6d7e8f9a1", nome: 'Escola Municipal Maria de Lourdes Santos', detalhes: '109 alunos matriculados' },
             { id: "d7e8f9a1-b2c3-4d4a-5b6c-c6d7e8f9a1b2", nome: 'Escola Municipal Maria Feijó', detalhes: '419 alunos matriculados' },
             { id: "e8f9a1b2-c3d4-4e5b-6c7d-d7e8f9a1b2c3", nome: 'Escola Municipal Menino Jesus', detalhes: '122 alunos matriculados' },
             { id: "f9a1b2c3-d4e5-4f6c-7d8e-e8f9a1b2c3d4", nome: 'Escola Municipal Miguel Calmon', detalhes: '302 alunos matriculados' },
             { id: "a1b2c3d4-e5f6-4a7b-8c9d-f9a1b2c3d4e5", nome: 'Escola Municipal Miguel Fontes', detalhes: '160 alunos matriculados' },
             { id: "b2c3d4e5-f6a7-4b8c-9d1a-a1b2c3d4e5f6", nome: 'Escola Municipal Ministro Marco Maciel', detalhes: '228 alunos matriculados' },
             { id: "c3d4e5f6-a7b8-4c9d-1a2b-b2c3d4e5f6a7", nome: 'Escola Municipal Nossa Senhora das Graças', detalhes: '62 alunos matriculados' },
             { id: "d4e5f6a7-b8c9-4d1a-2b3c-c3d4e5f6a7b8", nome: 'Escola Municipal Nossa Senhora dos Milagres', detalhes: '85 alunos matriculados' },
             { id: "e5f6a7b8-c9d1-4e2b-3c4d-d4e5f6a7b8c9", nome: 'Escola Municipal Nova Brasília', detalhes: '213 alunos matriculados' },
             { id: "f6a7b8c9-d1e2-4f3c-4d5e-e5f6a7b8c9d1", nome: 'Escola Municipal Padre Cícero', detalhes: '105 alunos matriculados' },
             { id: "a7b8c9d1-e2f3-4a4d-5e6f-f6a7b8c9d1e2", nome: 'Escola Municipal Paulo Freire', detalhes: '185 alunos matriculados' },
             { id: "b8c9d1e2-f3a4-4b5e-6f7a-a7b8c9d1e2f3", nome: 'Escola Municipal Pedro Furtado', detalhes: '313 alunos matriculados' },
             { id: "c9d1e2f3-a4b5-4c6f-7a8b-b8c9d1e2f3a4", nome: 'Escola Municipal Péricles Nogueira Magalhães', detalhes: '82 alunos matriculados' },
             { id: "d1e2f3a4-b5c6-4d7a-8b9c-c9d1e2f3a4b5", nome: 'Escola Municipal Professor Álvaro Palmeira', detalhes: '183 alunos matriculados' },
             { id: "e2f3a4b5-c6d7-4e8b-9c1d-d1e2f3a4b5c6", nome: 'Escola Municipal Professor Mário Laert', detalhes: '201 alunos matriculados' },
             { id: "f3a4b5c6-d7e8-4f9c-1d2e-e2f3a4b5c6d7", nome: 'Escola Municipal Professor Maurílio José do Espírito Santo', detalhes: '104 alunos matriculados' },
             { id: "a4b5c6d7-e8f9-4a1d-2e3f-f3a4b5c6d7e8", nome: 'Escola Municipal Professor Roberto Santos', detalhes: '260 alunos matriculados' },
             { id: "b5c6d7e8-f9a1-4b2e-3f4a-a4b5c6d7e8f9", nome: 'Escola Municipal Professora Adalgisa Santos', detalhes: '101 alunos matriculados' },
             { id: "c6d7e8f9-a1b2-4c3f-4a5b-b5c6d7e8f9a1", nome: 'Escola Municipal Professora Helenita Santana da Costa', detalhes: '141 alunos matriculados' },
             { id: "d7e8f9a1-b2c3-4d4a-5b6c-c6d7e8f9a1b2", nome: 'Escola Municipal Professora Julinda Capinam', detalhes: '88 alunos matriculados' },
             { id: "e8f9a1b2-c3d4-4e5b-6c7d-d7e8f9a1b2c3", nome: 'Escola Municipal Professora Luzia Margarida Pinto', detalhes: '153 alunos matriculados' },
             { id: "f9a1b2c3-d4e5-4f6c-7d8e-e8f9a1b2c3d4", nome: 'Escola Municipal Quilombola Mãe Ernestina', detalhes: '69 alunos matriculados' },
             { id: "a1b2c3d4-e5f6-4a7b-8c9d-f9a1b2c3d4e5", nome: 'Escola Municipal Quilombola Professor João Anastácio', detalhes: '38 alunos matriculados' },
             { id: "b2c3d4e5-f6a7-4b8c-9d1a-a1b2c3d4e5f6", nome: 'Escola Municipal Rui Barbosa', detalhes: '116 alunos matriculados' },
             { id: "c3d4e5f6-a7b8-4c9d-1a2b-b2c3d4e5f6a7", nome: 'Escola Municipal Santa Luzia', detalhes: '118 alunos matriculados' },
             { id: "d4e5f6a7-b8c9-4d1a-2b3c-c3d4e5f6a7b8", nome: 'Escola Municipal Santa Rita', detalhes: '32 alunos matriculados' },
             { id: "e5f6a7b8-c9d1-4e2b-3c4d-d4e5f6a7b8c9", nome: 'Escola Municipal Santa Terezinha', detalhes: '219 alunos matriculados' },
             { id: "f6a7b8c9-d1e2-4f3c-4d5e-e5f6a7b8c9d1", nome: 'Escola Municipal São Geraldo', detalhes: '173 alunos matriculados' },
             { id: "a7b8c9d1-e2f3-4a4d-5e6f-f6a7b8c9d1e2", nome: 'Escola Municipal São Izidoro', detalhes: '116 alunos matriculados' },
             { id: "b8c9d1e2-f3a4-4b5e-6f7a-a7b8c9d1e2f3", nome: 'Escola Municipal São José', detalhes: '128 alunos matriculados' },
             { id: "c9d1e2f3-a4b5-4c6f-7a8b-b8c9d1e2f3a4", nome: 'Escola Municipal Senhor do Bonfim', detalhes: '176 alunos matriculados' },
             { id: "d1e2f3a4-b5c6-4d7a-8b9c-c9d1e2f3a4b5", nome: 'Escola Municipal Tancredo de Almeida Neves', detalhes: '176 alunos matriculados' },
             { id: "e2f3a4b5-c6d7-4e8b-9c1d-d1e2f3a4b5c6", nome: 'Escola Municipal Tiradentes', detalhes: '169 alunos matriculados' },
             { id: "f3a4b5c6-d7e8-4f9c-1d2e-e2f3a4b5c6d7", nome: 'Escola Municipal Tomé de Souza', detalhes: '109 alunos matriculados' },
             { id: "a4b5c6d7-e8f9-4a1d-2e3f-f3a4b5c6d7e8", nome: 'Escola Municipal Uirassu de Assis Batista', detalhes: '228 alunos matriculados' },
             { id: "b5c6d7e8-f9a1-4b2e-3f4a-a4b5c6d7e8f9", nome: 'Escola Municipal Vale do Sol', detalhes: '208 alunos matriculados' },
             { id: "c6d7e8f9-a1b2-4c3f-4a5b-b5c6d7e8f9a1", nome: 'Escola Municipal Visconde do Rio Branco', detalhes: '143 alunos matriculados' }
         ];

        // --- GESTÃO DE ERROS ---
        function displayGlobalError(message) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md" role="alert">
                    <p class="font-bold text-lg mb-2">Erro Crítico de Acesso</p>
                    <p>${message}</p>
                </div>
            `;
        }

        const handleSnapshotError = (error) => {
            console.error("Firebase Snapshot Error:", error);
            if (error.code === 'permission-denied') {
                displayGlobalError('Permissão negada para aceder à base de dados. Por favor, verifique as <b>Regras de Segurança</b> do seu projeto Firebase Firestore. A aplicação não pode carregar os dados.');
            } else {
                displayGlobalError(`Ocorreu um erro inesperado ao carregar os dados: ${error.message}`);
            }
        };


        // --- AUTENTICAÇÃO E CONTROLE DE ACESSO ---
        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('auth-container');
            const registerContainer = document.getElementById('register-container');
            const appContainer = document.getElementById('app-container');

            if (user) {
                try {
                    const userDocRef = doc(db, `users`, user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists()) {
                        state.currentUser = { uid: user.uid, email: user.email, ...userDocSnap.data() };
                        document.getElementById('user-email').textContent = state.currentUser.email;
                        document.getElementById('user-role').textContent = state.currentUser.role;
                        
                        authContainer.classList.add('hidden');
                        registerContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        
                        initializeAppState();
                    } else {
                        console.error("Erro Crítico: Utilizador autenticado mas sem perfil na base de dados. A fazer logout forçado.");
                        document.getElementById('login-error').textContent = 'Erro de perfil. Por favor, tente registar-se novamente ou contacte o suporte.';
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Erro a obter dados do utilizador:", error);
                     if (error.code === 'permission-denied') {
                        document.getElementById('login-error').textContent = 'Erro de permissão. Verifique as regras do Firestore.';
                    } else {
                        document.getElementById('login-error').textContent = 'Erro ao carregar dados do utilizador.';
                    }
                    await signOut(auth);
                }
            } else {
                state.currentUser = null;
                appContainer.classList.add('hidden');
                registerContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
        });

        // --- LÓGICA DE LOGIN, CADASTRO E LOGOUT ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                 if (error.code === 'auth/invalid-credential') {
                    errorP.textContent = 'Credenciais inválidas. Verifique o e-mail e a senha.';
                } else {
                    errorP.textContent = 'Ocorreu um erro ao tentar entrar.';
                }
                console.error("Login failed:", error);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorP = document.getElementById('register-error');
            errorP.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, `users`, user.uid), {
                    email: user.email,
                    role: 'viewer' 
                });
            } catch (error) {
                errorP.textContent = 'Erro ao criar conta. Verifique o e-mail e a senha (mínimo 6 caracteres).';
                console.error("Registration failed:", error);
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });
        
        document.getElementById('show-register').addEventListener('click', (e) => {
             e.preventDefault();
             document.getElementById('auth-container').classList.add('hidden');
             document.getElementById('register-container').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
             e.preventDefault();
             document.getElementById('register-container').classList.add('hidden');
             document.getElementById('auth-container').classList.remove('hidden');
        });

        // --- FUNÇÕES DE EXPORTAÇÃO ---
        function exportToPdf(headers, data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 10,
            });
            doc.save(`${title}.pdf`);
        }

        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }

        // --- FUNÇÕES AUXILIARES DE RENDERIZAÇÃO ---
        function canEdit() {
            if (!state.currentUser) return false;
            return state.currentUser.role === 'admin' || state.currentUser.role === 'editor';
        }

        function createActionButton(id, text, icon, color) {
            if (!canEdit()) return '';
            return `<button id="${id}" class="${color} hover:opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas ${icon} mr-2"></i>${text}
                    </button>`;
        }
        
        // --- GERENCIAMENTO DE ESTADO E RENDERIZAÇÃO PRINCIPAL ---
        
        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        async function initializeAppState() {
            if (!state.currentUser) return;
             gerenciaIds.forEach(id => {
                const docRef = doc(db, `artifacts/${appId}/public/data/gerencias`, id);
                onSnapshot(docRef, (docSnap) => {
                    if (!docSnap.exists() && canEdit()) {
                        // Documento não existe, criar com estrutura vazia (ou inicial se for o primeiro acesso)
                        console.log(`Documento para ${id} não encontrado. Criando...`)
                         const baseData = {
                            id: id,
                            nome: GERENCIAS_INFO[id].nome,
                            escolas: escolasIniciais, // Preenche com a lista de escolas
                            projetosAtivos: [],
                            profissionaisLibra: (id === 'inclusao' || id === 'ameei') ? initialLibrasProfessionals : [], // Adiciona lista de LIBRAS
                            formacoes: [],
                            ...(id === 'inclusao' && { alunos: [], profissionaisApoio: [] })
                        };
                         setDoc(docRef, baseData).then(() => {
                             console.log(`Documento para ${id} criado com sucesso.`);
                             state.data[id] = baseData; // Atualiza o estado local imediatamente
                             if (state.selectedGerencia === id) render(); // Renderiza se esta gerência estiver selecionada
                         }).catch(e => console.error(`Erro ao criar documento para ${id}:`, e));
                    } else if (docSnap.exists()) {
                        // Documento existe, usar os dados
                        state.data[id] = docSnap.data();
                         if (state.selectedGerencia === id) render(); // Renderiza se esta gerência estiver selecionada
                    }
                }, handleSnapshotError);
            });

             const multimidiaDocRef = doc(db, `artifacts/${appId}/public/data/gerencias`, 'multimidia');
            onSnapshot(multimidiaDocRef, (docSnap) => {
                if (!docSnap.exists() && canEdit()) {
                     console.log(`Documento para multimidia não encontrado. Criando...`)
                    const baseData = { id: 'multimidia', midias: [] };
                    setDoc(multimidiaDocRef, baseData).then(() => {
                         console.log(`Documento para multimidia criado com sucesso.`);
                        state.data.multimidia = baseData;
                        if (state.selectedGerencia === 'multimidia') render();
                    }).catch(e => console.error("Erro ao criar doc multimidia:", e));
                } else if (docSnap.exists()) {
                     state.data.multimidia = docSnap.data();
                     if (state.selectedGerencia === 'multimidia') render();
                }
            }, handleSnapshotError);

            const docRefDocs = doc(db, `artifacts/${appId}/public/data/gerencias`, 'documentos');
            onSnapshot(docRefDocs, (docSnap) => {
                 if (!docSnap.exists() && canEdit()) {
                    console.log(`Documento para documentos não encontrado. Criando...`)
                    const baseData = { id: 'documentos', documentos: [] };
                    setDoc(docRefDocs, baseData).then(() => {
                         console.log(`Documento para documentos criado com sucesso.`);
                        state.data.documentos = baseData;
                         if (state.selectedGerencia === 'documentos') render();
                    }).catch(e => console.error("Erro ao criar doc documentos:", e));
                 } else if (docSnap.exists()) {
                    state.data.documentos = docSnap.data();
                    if (state.selectedGerencia === 'documentos') render();
                 }
            }, handleSnapshotError);
            
            renderSidebar();
            if(!state.selectedGerencia) setState({selectedGerencia: 'inclusao'});
            else render();
        }


        function render() {
            if (!state.selectedGerencia || !state.currentUser) {
                document.getElementById('content-area').innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-md">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-500 mb-4"></i>
                    <h2 class="text-3xl font-semibold text-gray-700">A carregar...</h2>
                </div>`;
                return;
            }
            renderHeader();
            renderContent();
            updateSidebarActiveState();
        }
        
        function renderSidebar() {
             const nav = document.getElementById('nav-gerencias');
            let navItems = '';
            // Usa gerenciaIds que já contém a ordem correta
            gerenciaIds.forEach(id => {
                const gerencia = GERENCIAS_INFO[id];
                navItems += `
                    <a href="#" data-gerencia="${id}" class="gerencia-link flex items-center space-x-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 transition-colors duration-200">
                        <i class="fas ${gerencia.icon} w-6 text-center"></i>
                        <span>${gerencia.nome}</span>
                    </a>`;
            });
            nav.innerHTML = navItems;
        }

        function updateSidebarActiveState() {
            document.querySelectorAll('.gerencia-link').forEach(link => {
                if (link.dataset.gerencia === state.selectedGerencia) {
                    link.classList.add('bg-gray-900', 'text-white');
                    link.classList.remove('text-gray-300');
                } else {
                    link.classList.remove('bg-gray-900', 'text-white');
                    link.classList.add('text-gray-300');
                }
            });
        }

        function renderHeader() {
             const title = document.getElementById('header-title');
            if (state.selectedGerencia && GERENCIAS_INFO[state.selectedGerencia]) { // Verifica se a gerencia existe
                title.innerHTML = `<i class="fas ${GERENCIAS_INFO[state.selectedGerencia].icon} text-blue-500"></i> ${GERENCIAS_INFO[state.selectedGerencia].nome}`;
            } else {
                 title.textContent = 'Bem-vindo!';
                 // Se a gerência selecionada não for válida, volta para a de inclusão
                 if (state.selectedGerencia && !GERENCIAS_INFO[state.selectedGerencia]) {
                     console.warn(`Gerência selecionada inválida: ${state.selectedGerencia}. Redirecionando para Inclusão.`);
                     setState({ selectedGerencia: 'inclusao', selectedAba: null });
                 }
            }
        }
        
        function renderContent() {
            const contentArea = document.getElementById('content-area');
             // Verifica se a gerência selecionada é válida antes de tentar obter os dados
            const data = GERENCIAS_INFO[state.selectedGerencia] ? state.data[state.selectedGerencia] || {} : {};
            
            const abasComuns = [ { id: 'escolas', nome: 'Unidades Escolares' }, { id: 'projetos', nome: 'Projetos Ativos' }, { id: 'libra', nome: 'Profissionais de LIBRAS' }, { id: 'formacao', nome: 'Formações' }, ];
            // Define abas específicas para 'inclusao'
            const abasInclusao = [ { id: 'alunos', nome: 'Alunos' }, { id: 'pa', nome: 'Profissionais de Apoio (PA)' }, ...abasComuns ];

            let abas;
             // Define quais abas usar baseado na gerência SELECIONADA
            if (state.selectedGerencia === 'inclusao') {
                abas = abasInclusao;
            } else if (GERENCIAS_INFO[state.selectedGerencia] && state.selectedGerencia !== 'multimidia' && state.selectedGerencia !== 'documentos') {
                 abas = abasComuns; // Usa abas comuns para outras diretorias válidas
            } else {
                abas = []; // Nenhuma aba para multimídia, documentos ou inválidas
            }


            // Define a aba padrão apenas se ainda não estiver definida ou se for inválida PARA AS ABAS ATUAIS
             if (!state.selectedAba || !abas.find(a => a.id === state.selectedAba)) {
                 if (state.selectedGerencia === 'multimidia') { state.selectedAba = 'midias' } 
                else if (state.selectedGerencia === 'documentos') { state.selectedAba = 'docs' } 
                else if (abas.length > 0) { state.selectedAba = abas[0].id; } // Usa a primeira aba válida como padrão
                else { state.selectedAba = null; }
            }
            
            let abasHtml = abas.map(aba => ` <button data-aba="${aba.id}" class="aba-link px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${state.selectedAba === aba.id ? 'bg-white text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}"> ${aba.nome} </button>`).join('');

            let contentHtml = '';
            // Renderiza conteúdo baseado na ABA selecionada
            switch(state.selectedAba) {
                case 'alunos': contentHtml = (state.selectedGerencia === 'inclusao') ? renderAlunos(data) : 'Aba não disponível para esta diretoria.'; break; // Só renderiza se for inclusao
                case 'pa': contentHtml = (state.selectedGerencia === 'inclusao') ? renderProfissionaisApoio(data) : 'Aba não disponível para esta diretoria.'; break; // Só renderiza se for inclusao
                case 'escolas': contentHtml = renderEscolas(data); break;
                case 'projetos': contentHtml = renderProjetos(data); break;
                case 'libra': contentHtml = renderLibra(data); break;
                case 'formacao': contentHtml = renderFormacao(data); break;
                case 'midias': contentHtml = renderMultimidia(state.data.multimidia || { midias: [] }); break;
                case 'docs': contentHtml = renderDocumentos(state.data.documentos || { documentos: [] }); break;
                default: contentHtml = `<div class="text-center p-10"><h2 class="text-2xl font-semibold text-gray-600">Selecione uma diretoria ou aba para visualizar o conteúdo.</h2></div>`;
            }

            const finalHtml = `
                ${abas.length > 0 ? `<div class="border-b border-gray-200 mb-6">${abasHtml}</div>` : ''}
                <div class="bg-white p-6 rounded-lg shadow-md">
                    ${contentHtml}
                </div>
            `;
            contentArea.innerHTML = finalHtml;
        }

        function createCard(title, value, icon) {
             return `<div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 flex items-center space-x-4">
                <div class="bg-blue-100 text-blue-500 rounded-full p-3">
                    <i class="fas ${icon} fa-2x"></i>
                </div>
                <div>
                    <p class="text-gray-500 text-sm font-medium">${title}</p>
                    <p class="text-3xl font-bold text-gray-800">${value}</p>
                </div>
            </div>`;
        }

        // --- RENDERIZAÇÃO DAS ABAS ESPECÍFICAS ---
        
        function renderAlunos(data) {
            const alunos = data.alunos || [];
            const laudados = alunos.filter(a => a.situacao === 'Laudado').length;
            const naoLaudados = alunos.filter(a => a.situacao === 'Não Laudado').length;
            const emInvestigacao = alunos.filter(a => a.situacao === 'Em Investigação').length;

            const cards = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    ${createCard('Alunos Laudados', laudados, 'fa-user-check')}
                    ${createCard('Alunos Não Laudados', naoLaudados, 'fa-user-clock')}
                    ${createCard('Alunos em Investigação', emInvestigacao, 'fa-user-magnifying-glass')}
                </div>`;
            const table = createDataTable('Alunos', 
                ['Nome', 'Escola', 'Situação', 'Deficiência'], 
                alunos, 
                (aluno) => [aluno.nome, aluno.escola, aluno.situacao, aluno.deficiencia || 'N/A'],
                'btn-add-aluno', 'btn-edit-aluno', 'alunos');
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Gestão de Alunos</h2>
                    ${createActionButton('btn-add-aluno', 'Adicionar Aluno', 'fa-plus', 'bg-green-500')}
                </div>
                ${cards}
                ${table}`;
        }

        function renderProfissionaisApoio(data) {
            const profissionais = data.profissionaisApoio || [];
            const card = createCard('Total de Profissionais de Apoio', profissionais.length, 'fa-user-shield');
            const table = createDataTable('Profissionais de Apoio',
                ['Nome', 'CPF', 'Telefone', 'Escola de Atuação'],
                profissionais,
                (pa) => [pa.nome, pa.cpf, pa.telefone, pa.escola],
                'btn-add-pa', 'btn-edit-pa', 'profissionaisApoio');

            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Gestão de Profissionais de Apoio (PA)</h2>
                    ${createActionButton('btn-add-pa', 'Adicionar Profissional', 'fa-plus', 'bg-green-500')}
                </div>
                <div class="mb-8 flex justify-center">${card}</div>
                ${table}`;
        }
        
        function renderLibra(data) {
            const profissionais = data.profissionaisLibra || [];
            const card = createCard('Total de Profissionais de LIBRAS', profissionais.length, 'fa-sign-language');
            const table = createDataTable('Profissionais de LIBRAS',
                ['Nome', 'Cargo/Função', 'Unidade Escolar', 'Alunos Atendidos'],
                profissionais,
                (p) => [p.nome, p.cargo, p.unidadeEscolar, p.alunosAtendidos],
                'btn-add-libra', 'btn-edit-libra', 'profissionaisLibra');

            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Gestão de Profissionais de LIBRAS</h2>
                    ${createActionButton('btn-add-libra', 'Adicionar Profissional', 'fa-plus', 'bg-green-500')}
                </div>
                <div class="mb-8 flex justify-center">${card}</div>
                ${table}`;
        }

        function createDataTable(title, headers, items, rowRenderer, addBtnId, editBtnClass, itemType) {
            const tableHeader = `
                <thead class="bg-gray-50">
                    <tr>
                        ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                        ${canEdit() ? '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>' : ''}
                    </tr>
                </thead>`;

            const tableBody = items.length > 0 ? items.map(item => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    ${rowRenderer(item).map(cell => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cell}</td>`).join('')}
                    ${canEdit() ? `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="${editBtnClass} text-indigo-600 hover:text-indigo-900" data-item='${JSON.stringify(item)}'><i class="fas fa-edit"></i></button>
                            <button class="btn-delete-item text-red-600 hover:text-red-900 ml-4" data-type="${itemType}" data-item='${JSON.stringify(item)}'><i class="fas fa-trash"></i></button>
                        </td>` : ''}
                </tr>`).join('') : `<tr><td colspan="${headers.length + (canEdit() ? 1 : 0)}" class="text-center py-10 text-gray-500">Nenhum item cadastrado.</td></tr>`;

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        ${tableHeader}
                        <tbody class="bg-white divide-y divide-gray-200">${tableBody}</tbody>
                    </table>
                </div>`;
        }
        
        function renderEscolas(data) {
            const total = data.escolas ? data.escolas.length : 0;
            const escolasHtml = (data.escolas && data.escolas.length > 0) ? data.escolas.map((escola) => `
                <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center border">
                    <div> <p class="font-semibold text-gray-800">${escola.nome}</p> <p class="text-sm text-gray-500">${escola.detalhes || 'Sem detalhes adicionais'}</p> </div>
                    ${canEdit() ? `<button class="btn-delete-item text-red-500 hover:text-red-700" data-type="escolas" data-item='${JSON.stringify(escola)}'><i class="fas fa-trash"></i></button>` : ''}
                </div>`).join('') : '<p class="text-gray-500 text-center col-span-full">Nenhuma unidade escolar cadastrada.</p>';

            return `<div class="flex justify-between items-center mb-6">
                        <div><h2 class="text-2xl font-bold text-gray-700">Unidades Escolares (${total})</h2></div>
                        <div class="flex space-x-2">
                           <button id="btn-export-escolas-pdf" class="bg-gray-700 hover:opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-file-pdf"></i> PDF</button>
                           <button id="btn-export-escolas-excel" class="bg-gray-700 hover:opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-file-excel"></i> Excel</button>
                           ${createActionButton('btn-add-escola', 'Adicionar Escola', 'fa-plus', 'bg-green-500')}
                        </div>
                    </div> <div class="space-y-4">${escolasHtml}</div>`;
        }

        function renderProjetos(data) {
            const total = data.projetosAtivos ? data.projetosAtivos.length : 0;
            const projetosHtml = (data.projetosAtivos && data.projetosAtivos.length > 0) ? data.projetosAtivos.map((projeto) => `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                         <p class="font-semibold text-gray-800">${projeto.nome}</p>
                         ${canEdit() ? `<button class="btn-delete-item text-red-500 hover:text-red-700" data-type="projetosAtivos" data-item='${JSON.stringify(projeto)}'><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">${projeto.descricao || 'Sem descrição.'}</p>
                </div>`).join('') : '<p class="text-gray-500 text-center col-span-full">Nenhum projeto ativo cadastrado.</p>';
            return `<div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-700">Projetos Ativos (${total})</h2>
                        <div class="flex space-x-2">
                            <button id="btn-export-projetos-pdf" class="bg-gray-700 hover:opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-file-pdf"></i> PDF</button>
                           <button id="btn-export-projetos-excel" class="bg-gray-700 hover:opacity-80 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-file-excel"></i> Excel</button>
                            ${createActionButton('btn-add-projeto', 'Adicionar Projeto', 'fa-plus', 'bg-green-500')}
                        </div>
                    </div> <div class="space-y-4">${projetosHtml}</div>`;
        }
        
        function renderFormacao(data) {
             const total = data.formacoes ? data.formacoes.length : 0;
            const formacoesHtml = (data.formacoes && data.formacoes.length > 0) ? data.formacoes.map((formacao) => `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                         <div> <p class="font-semibold text-gray-800">${formacao.nome}</p> <p class="text-sm text-gray-500">${formacao.data || 'Data a definir'}</p> </div>
                        ${canEdit() ? `<button class="btn-delete-item text-red-500 hover:text-red-700" data-type="formacoes" data-item='${JSON.stringify(formacao)}'><i class="fas fa-trash"></i></button>`: ''}
                    </div> <p class="text-sm text-gray-600 mt-2">${formacao.descricao || 'Sem descrição.'}</p>
                </div>`).join('') : '<p class="text-gray-500 text-center col-span-full">Nenhuma formação cadastrada.</p>';
             return `<div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-gray-700">Próximas Formações (${total})</h2> ${createActionButton('btn-add-formacao', 'Adicionar Formação', 'fa-plus', 'bg-green-500')} </div> <div class="space-y-4">${formacoesHtml}</div>`;
        }

        function renderMultimidia(data) {
            const total = data.midias ? data.midias.length : 0;
            const midiasHtml = (data.midias && data.midias.length > 0) ? data.midias.map((midia) => {
                const gerenciaInfo = GERENCIAS_INFO[midia.gerencia] || { nome: 'Desconhecida', icon: 'fa-question-circle' };
                let mediaElement = '';
                if(midia.type === 'image' && midia.url) {
                    mediaElement = `<img src="${midia.url}" alt="${midia.titulo}" class="mt-2 rounded-lg max-w-full h-auto shadow-md">`;
                } else if (midia.url) {
                    mediaElement = `<a href="${midia.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 hover:underline mt-2 inline-block truncate w-full">${midia.url}</a>`;
                }

                return `<div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start">
                         <div> <p class="font-semibold text-gray-800">${midia.titulo}</p> <p class="text-sm text-gray-500"> <i class="fas ${gerenciaInfo.icon} mr-1"></i> ${gerenciaInfo.nome} </p> </div>
                        ${canEdit() ? `<button class="btn-delete-item text-red-500 hover:text-red-700" data-type="midias" data-item='${JSON.stringify(midia)}'><i class="fas fa-trash"></i></button>`: ''}
                    </div> 
                    ${mediaElement}
                </div>`}).join('') : '<p class="text-gray-500 text-center col-span-full">Nenhum item de multimídia cadastrado.</p>';

             return `<div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-gray-700">Multimídia (${total})</h2> ${createActionButton('btn-add-midia', 'Adicionar Mídia', 'fa-plus', 'bg-green-500')} </div> <div class="space-y-4">${midiasHtml}</div>`;
        }

        function renderDocumentos(data) {
            const categorias = { 'Legislação': [], 'Planos e Projetos': [], 'Material de Apoio': [], 'Listagens': [] };
            const iconMap = { 'pdf': 'fa-file-pdf text-red-500', 'docx': 'fa-file-word text-blue-500', 'doc': 'fa-file-word text-blue-500' };
            if (data.documentos) { data.documentos.forEach(doc => { if (categorias[doc.categoria]) { categorias[doc.categoria].push(doc); } }); }
            let html = `<div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-gray-700">Documentos de Referência</h2> ${createActionButton('btn-add-documento', 'Adicionar Documento', 'fa-plus', 'bg-green-500')} </div>`;
            for (const categoria in categorias) {
                html += `<h3 class="text-xl font-semibold text-gray-600 mt-6 mb-3 border-b pb-2">${categoria}</h3>`;
                if (categorias[categoria].length > 0) {
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                    categorias[categoria].forEach(doc => {
                        html += `<div class="bg-gray-50 p-4 rounded-lg border flex items-center justify-between hover:shadow-lg transition-shadow">
                                <div class="flex items-center space-x-3 overflow-hidden">
                                     <i class="fas ${iconMap[doc.tipo] || 'fa-file-alt'} fa-2x"></i>
                                     <span class="font-medium text-gray-700 truncate" title="${doc.nome}">${doc.nome}</span>
                                </div>
                                ${canEdit() ? `<button class="btn-delete-item text-red-500 hover:text-red-700" data-type="documentos" data-item='${JSON.stringify(doc)}'><i class="fas fa-trash"></i></button>` : ''}
                            </div>`;
                    });
                    html += '</div>';
                } else { html += '<p class="text-gray-500">Nenhum documento nesta categoria.</p>'; }
            }
             return html;
        }
        
        // --- MODAIS E FORMULÁRIOS ---
        function openModal(title, formHtml) {
             document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = formHtml;
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.modal').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
             const modal = document.getElementById('modal');
             modal.querySelector('.modal').classList.add('scale-95', 'opacity-0');
            modal.querySelector('.modal').classList.remove('scale-100', 'opacity-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function createInput(id, label, type = 'text', value = '', placeholder = '') {
            return ` <div class="mb-4"> <label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}</label> <input type="${type}" id="${id}" value="${value}" placeholder="${placeholder}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500"> </div>`;
        }
         function createTextarea(id, label, value = '', placeholder = '') {
            return ` <div class="mb-4"> <label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}</label> <textarea id="${id}" placeholder="${placeholder}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500 h-24">${value}</textarea> </div>`;
        }
        function createSelect(id, label, options, selectedValue = '') {
            const optionsHtml = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `<div class="mb-4">
                        <label for="${id}" class="block text-gray-700 text-sm font-bold mb-2">${label}</label>
                        <select id="${id}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">
                            ${optionsHtml}
                        </select>
                    </div>`;
        }

        function createSubmitButton(text, id = '') {
             return `<button type="submit" ${id ? `id="${id}"` : ''} class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-transform transform hover:scale-105">${text}</button>`;
        }
        
        // --- MANIPULADORES DE EVENTOS ---

        document.addEventListener('click', async (e) => {
            const gerenciaLink = e.target.closest('.gerencia-link');
            if (gerenciaLink) { e.preventDefault(); setState({ selectedGerencia: gerenciaLink.dataset.gerencia, selectedAba: null }); if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('sidebar-closed'); document.getElementById('sidebar').classList.remove('sidebar-open'); } }
            
            const abaLink = e.target.closest('.aba-link');
            if (abaLink) { e.preventDefault(); setState({ selectedAba: abaLink.dataset.aba }); }

            const deleteBtn = e.target.closest('.btn-delete-item');
            if (deleteBtn && canEdit()) {
                const type = deleteBtn.dataset.type;
                const item = JSON.parse(deleteBtn.dataset.item);
                const gerencia = (type === 'midias') ? 'multimidia' : (type === 'documentos' ? 'documentos' : state.selectedGerencia);
                const field = (type === 'midias') ? 'midias' : (type === 'documentos' ? 'documentos' : type);
                if (confirm(`Tem certeza que deseja excluir "${item.nome || item.titulo}"?`)) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/gerencias`, gerencia);
                    await updateDoc(docRef, { [field]: arrayRemove(item) }).catch(err => console.error("Erro ao excluir item:", err));
                }
            }
            
            const actionButton = e.target.closest('button');
            if (!actionButton) return;
            
            const itemDataStr = actionButton.dataset.item;
            if(itemDataStr) {
                const item = JSON.parse(itemDataStr);
                if (actionButton.matches('.btn-edit-aluno')) {
                    openModal('Editar Aluno', `
                        <form id="form-edit-aluno" data-item-id="${item.id}">
                            ${createInput('alunoNome', 'Nome do Aluno', 'text', item.nome)}
                            ${createInput('alunoEscola', 'Escola', 'text', item.escola)}
                            ${createSelect('alunoSituacao', 'Situação', ['Laudado', 'Não Laudado', 'Em Investigação'], item.situacao)}
                            <div id="deficiencia-container" class="${item.situacao === 'Laudado' ? '' : 'hidden'}">
                                ${createInput('alunoDeficiencia', 'Tipo de Deficiência', 'text', item.deficiencia || '')}
                            </div>
                            ${createSubmitButton('Salvar Alterações')}
                        </form>
                    `);
                    return;
                }
                if (actionButton.matches('.btn-edit-pa')) {
                     openModal('Editar Profissional de Apoio', `
                        <form id="form-edit-pa" data-item-id="${item.id}">
                            ${createInput('paNome', 'Nome Completo', 'text', item.nome)}
                            ${createInput('paCpf', 'CPF', 'text', item.cpf)}
                            ${createInput('paTelefone', 'Telefone', 'text', item.telefone)}
                            ${createInput('paEscola', 'Escola de Atuação', 'text', item.escola)}
                            ${createSubmitButton('Salvar Alterações')}
                        </form>
                    `);
                    return;
                }
                 if (actionButton.matches('.btn-edit-libra')) {
                     openModal('Editar Profissional de LIBRAS', `
                        <form id="form-edit-libra" data-item-id="${item.id}">
                            ${createInput('libraNome', 'Nome Completo', 'text', item.nome)}
                            ${createInput('libraCargo', 'Cargo/Função', 'text', item.cargo)}
                            ${createInput('libraUnidade', 'Unidade Escolar', 'text', item.unidadeEscolar)}
                            ${createInput('libraAlunos', 'Alunos Atendidos', 'text', item.alunosAtendidos)}
                            ${createSubmitButton('Salvar Alterações')}
                        </form>
                    `);
                    return;
                }
            }


            switch (actionButton.id) {
                case 'btn-add-aluno':
                    openModal('Adicionar Aluno', `
                        <form id="form-add-aluno">
                            ${createInput('alunoNome', 'Nome do Aluno', 'text', '', 'Nome completo do aluno')}
                            ${createInput('alunoEscola', 'Escola', 'text', '', 'Escola onde está matriculado')}
                            ${createSelect('alunoSituacao', 'Situação', ['Laudado', 'Não Laudado', 'Em Investigação'])}
                            <div id="deficiencia-container" class="hidden">
                                ${createInput('alunoDeficiencia', 'Tipo de Deficiência', 'text', '', 'Ex: Autismo, TDAH, etc.')}
                            </div>
                            ${createSubmitButton('Adicionar Aluno')}
                        </form>
                    `);
                    break;
                case 'btn-add-pa':
                    openModal('Adicionar Profissional de Apoio', `
                        <form id="form-add-pa">
                            ${createInput('paNome', 'Nome Completo', 'text', '', 'Nome do profissional')}
                            ${createInput('paCpf', 'CPF', 'text', '', '000.000.000-00')}
                            ${createInput('paTelefone', 'Telefone', 'text', '', '(00) 00000-0000')}
                            ${createInput('paEscola', 'Escola de Atuação', 'text', '', 'Nome da escola')}
                            ${createSubmitButton('Adicionar Profissional')}
                        </form>
                    `);
                    break;
                case 'btn-add-libra':
                    openModal('Adicionar Profissional de LIBRAS', `
                        <form id="form-add-libra">
                            ${createInput('libraNome', 'Nome Completo', 'text', '', 'Nome do profissional')}
                            ${createInput('libraCargo', 'Cargo/Função', 'text', '', 'Ex: LIBRAS – NÍVEL II')}
                            ${createInput('libraUnidade', 'Unidade Escolar', 'text', '', 'Nome da escola')}
                            ${createInput('libraAlunos', 'Alunos Atendidos', 'text', '', 'Nome dos alunos')}
                            ${createSubmitButton('Adicionar Profissional')}
                        </form>
                    `);
                    break;
                 case 'btn-add-midia':
                    openModal('Adicionar Mídia', `
                        <form id="form-add-midia">
                            ${createInput('midiaTitulo', 'Título', 'text', '', 'Ex: Foto da Formação de Inclusão')}
                            ${createSelect('midiaTipo', 'Tipo de Mídia', ['Carregar Imagem', 'Link de Vídeo (YouTube, etc)'])}
                            <div id="midia-url-container" class="hidden">
                                ${createInput('midiaUrl', 'URL do Vídeo', 'url', '', 'https://www.youtube.com/watch?v=...')}
                            </div>
                            <div id="midia-file-container">
                                ${createInput('midiaFile', 'Ficheiro de Imagem', 'file')}
                            </div>
                            ${createSubmitButton('Adicionar Mídia', 'submit-midia-btn')}
                        </form>
                    `);
                    break;
                 case 'btn-export-escolas-pdf':
                    exportToPdf(['Nome', 'Detalhes'], state.data[state.selectedGerencia]?.escolas.map(e => [e.nome, e.detalhes]) || [], 'Unidades_Escolares');
                    break;
                case 'btn-export-escolas-excel':
                    exportToExcel(state.data[state.selectedGerencia]?.escolas || [], 'Unidades_Escolares');
                    break;
                case 'btn-export-projetos-pdf':
                     exportToPdf(['Nome', 'Descrição'], state.data[state.selectedGerencia]?.projetosAtivos.map(p => [p.nome, p.descricao]) || [], 'Projetos_Ativos');
                    break;
                case 'btn-export-projetos-excel':
                    exportToExcel(state.data[state.selectedGerencia]?.projetosAtivos || [], 'Projetos_Ativos');
                    break;
                case 'menu-button': document.getElementById('sidebar').classList.toggle('sidebar-closed'); document.getElementById('sidebar').classList.toggle('sidebar-open'); break;
                case 'modal-close': closeModal(); break;
                case 'btn-add-escola': openModal('Adicionar Unidade Escolar', `<form id="form-add-escola"> ${createInput('escolaNome', 'Nome da Escola', 'text', '', 'Ex: E.M. Prof. João da Silva')} ${createTextarea('escolaDetalhes', 'Detalhes (Endereço, etc)', '', 'Ex: Rua Principal, 123, Centro')} ${createSubmitButton('Adicionar Escola')} </form>`); break;
                case 'btn-add-projeto': openModal('Adicionar Projeto Ativo', `<form id="form-add-projeto"> ${createInput('projetoNome', 'Nome do Projeto', 'text', '', 'Ex: Inclusão Digital na Escola')} ${createTextarea('projetoDescricao', 'Descrição do Projeto')} ${createSubmitButton('Adicionar Projeto')} </form>`); break;
                case 'btn-add-formacao': openModal('Adicionar Formação', `<form id="form-add-formacao"> ${createInput('formacaoNome', 'Nome da Formação', 'text', '', 'Ex: Capacitação em Autismo')} ${createInput('formacaoData', 'Data da Formação', 'date')} ${createTextarea('formacaoDescricao', 'Descrição da Formação')} ${createSubmitButton('Adicionar Formação')} </form>`); break;
                case 'btn-add-documento':
                    let catOptions = ['Legislação', 'Planos e Projetos', 'Material de Apoio', 'Listagens'].map(c => `<option value="${c}">${c}</option>`).join('');
                    openModal('Adicionar Documento', `
                        <form id="form-add-documento">
                            ${createInput('docNomeFake', 'Selecione o arquivo', 'file')}
                             <div class="mb-4">
                               <label for="docCategoria" class="block text-gray-700 text-sm font-bold mb-2">Categoria</label>
                               <select id="docCategoria" class="shadow border rounded w-full py-2 px-3 text-gray-700">${catOptions}</select>
                            </div>
                            <p class="text-xs text-gray-500 mb-4">Nota: O upload real do arquivo não é suportado. Apenas o nome do arquivo será salvo como referência.</p>
                            ${createSubmitButton('Adicionar Referência do Documento')}
                        </form>
                    `);
                    break;
            }
        });
        
        // --- MANIPULADORES DE SUBMISSÃO DE FORMULÁRIO ---
        document.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!canEdit()) return;
            const form = e.target;
            const docRef = doc(db, `artifacts/${appId}/public/data/gerencias`, state.selectedGerencia);
            
            switch (form.id) {
                case 'form-add-aluno': {
                    const newAluno = { id: crypto.randomUUID(), nome: form.alunoNome.value, escola: form.alunoEscola.value, situacao: form.alunoSituacao.value, deficiencia: form.alunoSituacao.value === 'Laudado' ? form.alunoDeficiencia.value : '', };
                    await updateDoc(docRef, { alunos: arrayUnion(newAluno) });
                    break;
                }
                case 'form-edit-aluno': {
                    const itemId = form.dataset.itemId;
                    const updatedItems = (state.data.inclusao.alunos || []).map(item => (item.id === itemId) ? { ...item, nome: form.alunoNome.value, escola: form.alunoEscola.value, situacao: form.alunoSituacao.value, deficiencia: form.alunoSituacao.value === 'Laudado' ? form.alunoDeficiencia.value : '' } : item);
                    await updateDoc(docRef, { alunos: updatedItems });
                    break;
                }
                 case 'form-add-pa': {
                    const newItem = { id: crypto.randomUUID(), nome: form.paNome.value, cpf: form.paCpf.value, telefone: form.paTelefone.value, escola: form.paEscola.value };
                    await updateDoc(docRef, { profissionaisApoio: arrayUnion(newItem) });
                    break;
                }
                case 'form-edit-pa': {
                    const itemId = form.dataset.itemId;
                    const updatedItems = (state.data.inclusao.profissionaisApoio || []).map(item => (item.id === itemId) ? { ...item, nome: form.paNome.value, cpf: form.paCpf.value, telefone: form.paTelefone.value, escola: form.paEscola.value } : item);
                    await updateDoc(docRef, { profissionaisApoio: updatedItems });
                    break;
                }
                case 'form-add-libra': {
                    const newItem = { id: crypto.randomUUID(), nome: form.libraNome.value, cargo: form.libraCargo.value, unidadeEscolar: form.libraUnidade.value, alunosAtendidos: form.libraAlunos.value };
                    await updateDoc(docRef, { profissionaisLibra: arrayUnion(newItem) });
                    break;
                }
                case 'form-edit-libra': {
                    const itemId = form.dataset.itemId;
                    const currentGerenciaData = state.data[state.selectedGerencia] || { profissionaisLibra: [] };
                    const updatedItems = (currentGerenciaData.profissionaisLibra || []).map(item => (item.id === itemId) ? { ...item, nome: form.libraNome.value, cargo: form.libraCargo.value, unidadeEscolar: form.libraUnidade.value, alunosAtendidos: form.libraAlunos.value } : item);
                    await updateDoc(docRef, { profissionaisLibra: updatedItems });
                    break;
                }
                case 'form-add-midia': {
                    const submitBtn = form.querySelector('#submit-midia-btn');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> A adicionar...';

                    const midiaTipo = form.midiaTipo.value;
                    const titulo = form.midiaTitulo.value;
                    let newItem = { id: crypto.randomUUID(), titulo, gerencia: state.selectedGerencia }; // Usar a gerência selecionada AQUI

                    try {
                        if (midiaTipo === 'Carregar Imagem') {
                            const file = form.midiaFile.files[0];
                            if (!file) {
                                alert('Por favor, selecione um ficheiro de imagem.');
                                submitBtn.disabled = false; submitBtn.textContent = 'Adicionar Mídia'; // Reabilita botão
                                return; // Não fecha modal
                            }
                            const storageRef = ref(storage, `images/${Date.now()}_${file.name}`);
                            await uploadBytes(storageRef, file);
                            const downloadURL = await getDownloadURL(storageRef);
                            newItem.url = downloadURL;
                            newItem.type = 'image';
                        } else {
                            if (!form.midiaUrl.value) {
                                alert('Por favor, insira a URL do vídeo.');
                                submitBtn.disabled = false; submitBtn.textContent = 'Adicionar Mídia'; // Reabilita botão
                                return; // Não fecha modal
                            }
                            newItem.url = form.midiaUrl.value;
                            newItem.type = 'video';
                        }
                        const midiaDocRef = doc(db, `artifacts/${appId}/public/data/gerencias`, 'multimidia');
                        await updateDoc(midiaDocRef, { midias: arrayUnion(newItem) });
                    } catch (error) {
                        console.error("Erro ao adicionar mídia:", error);
                        alert(`Erro ao adicionar mídia: ${error.message}`);
                    } finally {
                        if (!e.defaultPrevented) { // Fecha modal apenas se não houve erro que impediu
                           closeModal();
                        } else {
                           submitBtn.disabled = false; submitBtn.textContent = 'Adicionar Mídia';
                        }
                    }
                    return; // Retorna para não fechar o modal antes do upload
                }
                case 'form-add-escola': await updateDoc(docRef, { escolas: arrayUnion({ id: crypto.randomUUID(), nome: form.escolaNome.value, detalhes: form.escolaDetalhes.value }) }); break;
                case 'form-add-projeto': await updateDoc(docRef, { projetosAtivos: arrayUnion({ id: crypto.randomUUID(), nome: form.projetoNome.value, descricao: form.projetoDescricao.value }) }); break;
                case 'form-add-formacao': await updateDoc(docRef, { formacoes: arrayUnion({ id: crypto.randomUUID(), nome: form.formacaoNome.value, data: form.formacaoData.value, descricao: form.formacaoDescricao.value }) }); break;
                case 'form-add-documento': {
                    const fileInput = form.querySelector('#docNomeFake');
                    if (fileInput.files.length > 0) {
                        const nome = fileInput.files[0].name;
                        const tipo = nome.split('.').pop().toLowerCase();
                        const newItem = { id: crypto.randomUUID(), nome: nome, categoria: form.docCategoria.value, tipo: tipo };
                        const docRefDocs = doc(db, `artifacts/${appId}/public/data/gerencias`, 'documentos');
                        await updateDoc(docRefDocs, { documentos: arrayUnion(newItem) });
                    } else {
                        alert("Por favor, selecione um arquivo.");
                        return;
                    }
                    break;
                }
            }
            closeModal(); // Fecha modal após sucesso (exceto upload de mídia)
        });

        document.addEventListener('change', (e) => {
            const form = e.target.closest('form');
            if(!form) return;

            if (e.target.id === 'alunoSituacao') {
                const deficienciaContainer = form.querySelector('#deficiencia-container');
                if (e.target.value === 'Laudado') {
                    deficienciaContainer.classList.remove('hidden');
                } else {
                    deficienciaContainer.classList.add('hidden');
                }
            }
            if(e.target.id === 'midiaTipo') {
                const urlContainer = form.querySelector('#midia-url-container');
                const fileContainer = form.querySelector('#midia-file-container');
                if (e.target.value === 'Link de Vídeo (YouTube, etc)') {
                    urlContainer.classList.remove('hidden');
                    fileContainer.classList.add('hidden');
                } else {
                    urlContainer.classList.add('hidden');
                    fileContainer.classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>

